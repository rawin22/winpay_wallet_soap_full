@using System.Globalization
@using Tsg.UI.Main.App_LocalResources
@using TSG.Models.Enums
@using TSG.Models.ServiceModels.LimitPayment
@using WinstantPay.Common.Extension
@model TSG.Models.ServiceModels.LimitPayment.DaPayLimitsSo

@{
    ViewBag.Title = GlobalRes.DelegatedAuthority_Title;
    Layout = "~/Views/Shared/_LayoutMain.cshtml";
    Model.DaPayLimits_DateOfExpireString = (Model.DaPayLimits_DateOfExpire ?? DateTime.Now).ToString("dd/MM/yyyy", CultureInfo.CreateSpecificCulture("en-US"));
}
<link rel="stylesheet" href="/Content/assets/vendor/select2/css/select2.css" />
<link rel="stylesheet" href="/Content/assets/vendor/select2-bootstrap-theme/select2-bootstrap.css" />
<script src="/Content/assets/vendor/select2/js/select2.js"></script>

<link href="/Content/assets/vendor/bootstrap-toggle/css/bootstrap-toggle.css" rel="stylesheet">
<script src="/Content/assets/vendor/bootstrap-toggle/js/bootstrap-toggle.js"></script>

<link rel="stylesheet" href="/Content/assets/vendor/bootstrap-timepicker/css/bootstrap-timepicker.css">
<script src="/Content/assets/vendor/bootstrap-timepicker/bootstrap-timepicker.js"></script>
<script src="/Scripts/jquery.unobtrusive-ajax.min.js" type="text/javascript"></script>

@*<link rel="stylesheet" href="/Content/assets/vendor/bootstrap/css/bootstrap.css">*@
<link rel="stylesheet" href="/Content/assets/vendor/bootstrap-datepicker/css/bootstrap-datepicker3.css">
<link rel="stylesheet" href="/Content/assets/vendor/bootstrap-multiselect/bootstrap-multiselect.css">
<link rel="stylesheet" href="/Content/assets/vendor/bootstrap-tagsinput/bootstrap-tagsinput.css">
<link rel="stylesheet" href="/Content/assets/vendor/bootstrap-colorpicker/css/bootstrap-colorpicker.css">
<link rel="stylesheet" href="/Content/assets/vendor/bootstrap-timepicker/css/bootstrap-timepicker.css">
<link rel="stylesheet" href="/Content/assets/vendor/bootstrap-markdown/css/bootstrap-markdown.min.css">

@*<script src="/Content/assets/vendor/bootstrap/js/bootstrap.js"></script>*@
@*<script src="/Content/assets/vendor/bootstrap/js/bootstrap.js"></script>*@
<script src="/Content/assets/vendor/jquery-ui/jquery-ui.js"></script>
<script src="/Content/assets/vendor/jqueryui-touch-punch/jqueryui-touch-punch.js"></script>
<script src="/Content/assets/vendor/bootstrap-multiselect/bootstrap-multiselect.js"></script>
<script src="/Content/assets/vendor/jquery-maskedinput/jquery.maskedinput.js"></script>
<script src="/Content/assets/vendor/bootstrap-tagsinput/bootstrap-tagsinput.js"></script>
<script src="/Content/assets/vendor/bootstrap-colorpicker/js/bootstrap-colorpicker.js"></script>
<script src="/Content/assets/vendor/bootstrap-timepicker/bootstrap-timepicker.js"></script>
<script src="/Content/assets/vendor/bootstrap-maxlength/bootstrap-maxlength.js"></script>
@*<script src="/Content/assets/vendor/bootstrap-confirmation/bootstrap-confirmation.js"></script>*@

<style>
    .toggle-on {
        color: #ffffff !important;
    }

    .row.disable div:not(:first-child) {
        opacity: 0.4;
    }

    .checkbox, .toggle-group {
        opacity: 1 !important;
    }

    .red {
        color: red;
    }

    a[disabled] {
        pointer-events: not-allowed;
    }

    .btn[disabled], .bnt-success[disabled] {
        cursor: not-allowed;
    }


    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
        /* display: none; <- Crashes Chrome on hover */
        -webkit-appearance: none;
        margin: 0; /* <-- Apparently some margin are still there even though it's hidden */
    }
</style>

<script type="text/javascript">
    function DaCreateCompleted(data) {
        console.log(data);

        $('#LoadingOverlayApi').trigger('loading-overlay:hide');
        if (data.responseJSON && !data.responseJSON.Success) {
            if (data.responseJSON.InfoBlock) {
                $('#limitationBlock').append('<div class="alert alert-danger">' +
                    data.responseJSON.InfoBlock.UserMessage +
                    '</div>');
            } else {
                $('#limitationBlock').append('<div class="alert alert-danger">' +
                    '@GlobalRes.ShopingCardController_UnspecError' +
                    '</div>');
            }
            setTimeout(function(){ $('#limitationBlock').empty(); }, 3000);
        } else {
            if ($('#saveBlock')) {
                $('#saveBlock').remove();
            }
            if (data.responseJSON.DaPayLimits_ID !== "undefined" || data.responseJSON.DaPayLimits_ID !== '@Guid.Empty') {
                console.log(data.responseJSON);
                window.location.href = '@Url.Action("Edit", "DaPaymentLimitsList")' + '/' + data.responseJSON.DaPayLimits_ID;
            }
            $(".disable").find('input[type="number"]').prop("disabled", true);
            $(".disable").find('button').prop("disabled", true);
            $('input[type="checkbox"]').bootstrapToggle();
        }
    }
    function CheckForm() {
        //if (!$('#DaPayLimits_CcyCode :selected').val() || $('#DaPayLimits_CcyCode :selected').val() === "") {
        //    $('#DaPayLimits_CcyCode_validationMessage').removeClass("hidden");
        //    return false;
        //}
        //alert($("#DaPayLimits_CcyCode").val().length);
        //if (!$("#DaPayLimits_CcyCode").val().length>0) {
        //    $('#DaPayLimits_CcyCode_validationMessage').removeClass("hidden");
        //    return false;
        //}

        if ($("#text_DaPayLimits_LimitCodeInitialization").val() === "" && $("#text_DaPayLimits_LimitCodeInitialization").val().match("^(?=.{6,20}$)[a-zA-Z0-9]+([a-zA-Z0-9]+)?$")==null) {
            $('#DaPayLimits_LimitCodeInitialization_validationMessage').removeClass("hidden");
            return false;
        }
        $('#LoadingOverlayApi').trigger('loading-overlay:show');
        return true;
    }
</script>
<div class="row">
    <section class="panel">
        <header class="panel-heading" data-panel-toggle="">
            <div class="panel-actions">
                <a href="#" class="panel-action panel-action-toggle" data-panel-toggle=""></a>
            </div>

            <h2 class="panel-title">@GlobalRes.DelegatedAuthority_Title</h2>
            <p class="panel-subtitle">@GlobalRes.DelegatedAuthority_EditSubTitle</p>
        </header>
        <script type="text/javascript">
        function DaCreateCompleted(data) {
            console.log(data);

            if (data.responseJSON && !data.responseJSON.Success) {
                $('#LoadingOverlayApi').trigger('loading-overlay:hide');

                if (data.responseJSON.InfoBlock) {
                    $('#limitationBlock').append('<div class="alert alert-danger">' +
                        data.responseJSON.InfoBlock.UserMessage +
                        '</div>');
                } else {
                    $('#limitationBlock').append('<div class="alert alert-danger">' +
                        '@GlobalRes.ShopingCardController_UnspecError' +
                        '</div>');
                }
                setTimeout(function () { $('#limitationBlock').empty(); }, 3000);
                $("#saveDauth").prop('disabled', false);
            } else if (data.responseJSON && data.responseJSON.Success) {
                $('#limitationBlock').append('<div class="alert alert-success">' + data.responseJSON.InfoBlock.UserMessage  +'</div>');
                setTimeout(function () {
                    $('#limitationBlock').empty();
                    window.location.href = '@(Url.Action("Index", "DelegatedAuthority"))';
                }, 3000);


                $(".disable").find('input[type="number"]').prop("disabled", true);
                $(".disable").find('button').prop("disabled", true);
                $('input[type="checkbox"]').bootstrapToggle();
            }
        }
        function CheckForm() {
            $("#saveDauth").prop('disabled', true);
            if (!$('#DaPayLimits_CcyCode').val() === "") {
                $('#DaPayLimits_CcyCode_validationMessage').removeClass("hidden");
                return false;
            }
            if (!$("#text_DaPayLimits_LimitCodeInitialization").val() || $("#text_DaPayLimits_LimitCodeInitialization").val().lenght < 6) {
                $('#DaPayLimits_LimitCodeInitialization_validationMessage').removeClass("hidden");
            }

            //alert(parseFloat($("#DaPayLimits_RequiredPinAmount").val()))
            //alert(parseFloat($("#DaPayLimits_RequiredPinAmount").val()) > 0);
            //alert($("#DaPayLimits_PinCode").val().length < 4);
            if (parseFloat($("#DaPayLimits_RequiredPinAmount").val()) > 0 && $("#DaPayLimits_PinCode").val().length <4) {
                $('#DaPayLimits_PinCode_Required_validationMessage').removeClass("hidden");
                console.log("DaPayLimits_RequiredPinAmount is greater than 0 and PIN is required");
                $("#saveDauth").prop('disabled', false);
                return false;
            }


            $('#LoadingOverlayApi').trigger('loading-overlay:show');

            return true;
        }
        </script>


        @{
            AjaxOptions options = new AjaxOptions();
            options.OnComplete = "DaCreateCompleted";
            options.OnBegin = "CheckForm";
        }
        @using (Ajax.BeginForm("Edit", "DaPaymentLimitsList", options))
        {
            @Html.HiddenFor(h => h.DaPayLimits_ID)
            @Html.HiddenFor(h => h.DaPayLimits_SourceType)
            @Html.HiddenFor(h => h.DaPayLimits_StatusByLimit)
            @*@Html.HiddenFor(h => h.DaPayLimits_IsRestrictedToSelectedCurrency)
            @Html.HiddenFor(h => h.DaPayLimits_CcyCode, new { id = "DaPayLimits_CcyCode", required = "required" })*@


            <div class="panel-body" style="display: block;">
                <div class="row">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">
                            @GlobalRes.DelegatedAuthority_SetMediaName <span class="required" aria-required="true">*</span>
                        </label>
                        <div class="col-sm-5">
                            @Html.TextBoxFor(m => m.DaPayLimits_MediaName, new { @class = "form-control", disabled = "disabled" })
                            @Html.ValidationMessageFor(m => m.DaPayLimits_MediaName, GlobalRes.DelegatedAuthority_MediaNameValidationError, new { @id = "DaPayLimits_MediaName_ValidationMessage", @class = "hidden red" })
                        </div>
                    </div>

                    <div class="form-group @(Model.AccountWPayIds.Count > 1? "":"hidden")">
                        <label class="col-sm-3 control-label">WPayId</label>
                        <div class="col-sm-5">
                            @Html.DropDownListFor(m => m.DaPayLimits_WPayId, Model.AccountWPayIds, new { @class = "form-control"})
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label"> @GlobalRes.DelegatedAuthority_ExpDate</label>

                        @if (!Model.DaPayLimits_DateOfExpire.HasValue)
                        {
                            <div class="col-sm-4">

                                <span class="btn btn-default" id="btnAddDateTime"><i class="fa fa-plus-circle" style="color: green; padding-right: 0.5em"></i>@GlobalRes.DelegatedAuthority_AddExpDate</span>
                            </div>
                        }
                        <div class="col-sm-3 @(Model.DaPayLimits_DateOfExpire.HasValue ?"" :"hidden")" id="blockDateExpire">
                            <div class="input-group date" data-plugin-datepicker="" data-date-format="dd/mm/yyyy" id="dp3">
                                <span class="input-group-addon">
                                    <i class="fa fa-calendar"></i>
                                </span>
                                <input type="text" data-plugin-datepicker="" name="DaPayLimits_DateOfExpireString" id="DaPayLimits_DateOfExpireString"
                                       data-date-format="dd/mm/yyyy" data-plugin-options="{ &quot;todayHighlight&quot;: true, &quot;startDate&quot;: &quot;@(DateTime.Now.ToString("dd/MM/yyyy"))&quot; }"
                                       value="@(Model.DaPayLimits_DateOfExpire.HasValue ? Model.DaPayLimits_DateOfExpire?.ToString("dd/MM/yyyy") :"")" readonly="readonly" class="form-control">

                            </div>
                        </div>
                        <div class="col-sm-2 @(Model.DaPayLimits_DateOfExpire.HasValue ?"" :"hidden")" id="blockTimeExpire">
                            <div class="input-group">
                                <span class="input-group-addon">
                                    <i class="fa fa-clock-o"></i>
                                </span>
                                <input type="text" data-plugin-timepicker="" name="DaPayLimits_TimeOfExpireString" id="DaPayLimits_TimeOfExpireString" class="form-control" data-plugin-options='{ "showMeridian": false }'>

                                @*<input type="text" data-plugin-timepicker=""
                                value='@(Model.DaPayLimits_DateOfExpire.HasValue ? Model.DaPayLimits_DateOfExpire.Value.ToString("HH:mm") : "")' name="DaPayLimits_TimeOfExpireString" id="DaPayLimits_TimeOfExpireString" class="form-control" data-plugin-options='{ "showMeridian": false }'>*@
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-3 control-label">
                            @(EnumHelper<DelegatedAuthorirySourceLimitationTypeEnum>.GetDisplayValue((DelegatedAuthorirySourceLimitationTypeEnum)Model.DaPaymentLimitSourceType.DaPaymentLimitSourceType_EnumNumber))
                        </label>
                        <div class="col-sm-5">
                            @if (Model.DaPaymentLimitSourceType.DaPaymentLimitSourceType_SysName == "QrCode")
                            {
                                <script type="text/javascript" src="~/Content/assets/vendor/jquery/jquery.js"></script>
                                <script type="text/javascript" src="~/Content/assets/vendor/qrcode/qrcode.js"></script>
                                <div id="qrcode"></div>

                                <script>
                                    //var qrcode = new QRCode(document.getElementById("qrcode"),
                                    //    {
                                    //        width: 200,
                                    //        height: 200
                                    //    });

                                    function makeCode() {
                                        //qrcode.makeCode('@Model.DaPayLimits_LimitCodeInitialization');
                                        var code = '@Model.DaPayLimits_LimitCodeInitialization';
                                        var mytext = {
                                            Text: code
                                        };
                                        var jsontext = JSON.stringify(mytext);
                                        console.log("jsontext: " + jsontext);
                                        console.log("Run ApiGenerateQrCodeAsBase64");
                                        $.ajax({
                                            url: "/api/ApiGenerateQrCodeAsBase64",
                                            //headers: {
                                            //  'Accept': 'application/json',
                                            //  'Content-Type': 'application/json'
                                            //},
                                            type: "POST",
                                            data: jsontext,
                                            dataType: "json",
                                            contentType: 'application/json; charset=utf-8',
                                            success: function (qrcoderesult, textStatus, jqXHR) {
                                                //data - response from server
                                                console.log("ApiGenerateQrCodeAsBase64 - Success");
                                                console.log("qrcoderesult.QrCodeAsBase64 : " + qrcoderesult.QrCodeAsBase64);
                                                var binary = "";
                                                var responseText = jqXHR.responseText;
                                                var responseTextLen = responseText.length;

                                                for (i = 0; i < responseTextLen; i++) {
                                                    binary += String.fromCharCode(responseText.charCodeAt(i) & 255)
                                                }
                                                // $("#imgqrcode").attr("src", "data:image/png;base64," + btoa(binary));
                                                $('#qrcode').html('<img width="300" height="300" src="data:image/png;base64,' + qrcoderesult.QrCodeAsBase64 + '" />');
                                            },
                                            //success: function (result) {
                                            //    console.log("Run MakeQrCode - Success");
                                            //    document.getElementById("Memo").innerHTML = result.shortUrl;
                                            //    //document.getElementById("currencyExchangePartView").innerHTML = result;
                                            //    //$('#LoadingOverlayApi').trigger('loading-overlay:hide');
                                            //},
                                            error: function (jqXhr, textStatus, errorThrown) {
                                                console.log("ApiGenerateQrCodeAsBase64 - Failed");
                                                console.log(jqXhr);
                                                console.log(textStatus);
                                                console.log(errorThrown);
                                            }
                                            //error: function (result)
                                            //{
                                            //    console.log("Run MakeQrCode - Failed - Result:" + result);
                                            //}
                                        });
                                    }

                                    makeCode();

                                    $("#printQRBtn").click(function() {
                                        PrintElem("qrcode");
                                    });

                                    $("#downloadQRBtn").click(function() {
                                        var geImage = $('#qrcode img');
                                        if (geImage.length > 0) {
                                            var link = document.createElement("a");
                                            link.setAttribute("href", geImage[0].src);
                                            link.setAttribute("download",
                                                "qrFor" +
                                                @*'@(String.Format("{0}{1}.jpg", Model.DaPayLimits_CcyCode, Model.DaPayLimits_ID))');*@
                                                '@(String.Format("{0}.jpg", Model.DaPayLimits_ID))');
                                            link.click();
                                        }
                                    });

                                    function PrintElem(elem) {
                                        var mywindow = window.open('', 'PRINT', 'height=400,width=600');

                                        mywindow.document.write('<html><head><title>' + document.title + '</title>');
                                        mywindow.document.write('</head><body >');
                                        mywindow.document.write(document.getElementById(elem).innerHTML);
                                        mywindow.document.write('</body></html>');
                                        mywindow.document.close(); // necessary for IE >= 10
                                        mywindow.focus(); // necessary for IE >= 10*/
                                        mywindow.print();
                                        mywindow.close();

                                        return true;
                                    }


                                    function saveBase64AsFile(base64, fileName) {

                                        var link = document.getElementById("a");

                                        link.setAttribute("href", base64);
                                        link.setAttribute("download", fileName);
                                        link.click();
                                    }

                                </script>

                            }
                            @if (Model.DaPaymentLimitSourceType.DaPaymentLimitSourceType_SysName == "NFC")
                            {
                                <span class="alert alert-success">Device connected</span>

                            }
                            @if (Model.DaPaymentLimitSourceType.DaPaymentLimitSourceType_SysName == "SecretPhrase")
                            {
                                @Html.TextBoxFor(t => t.DaPayLimits_LimitCodeInitialization, new { id = "text_DaPayLimits_LimitCodeInitialization", @class = "form-control" })
                                @Html.ValidationMessageFor(m => m.DaPayLimits_LimitCodeInitialization, GlobalRes.DelegatedAuthority_SecretCodeRequirements, new { @id = "DaPayLimits_LimitCodeInitialization_validationMessage", @class = "hidden red" })

                            }
                            @if (Model.DaPaymentLimitSourceType.DaPaymentLimitSourceType_SysName == "BarCode")
                            {
                                <script src="~/Content/BarCode/JsBarcode.all.min.js"></script>
                                <img id="barcode" />
                                <script type="text/javascript">
                                    $("#barcode").JsBarcode('@Model.DaPayLimits_LimitCodeInitialization',
                                        {
                                            displayValue: false,
                                            width: 1,
                                            height: 50
                                        });
                                </script>
                            }
                        </div>
                    </div>
                    @if (!Model.DaPayLimits_IsTransfered)
                    {
                        <div class="form-group">
                            <label class="col-sm-3 control-label" id="transferTokenLabel"> &nbsp;</label>
                            <div class="col-sm-5">
                                <span class="btn btn-default" id="btnLoadTransferTokenLogic">@GlobalRes.CommonBtns_Transfers<i class="fa fa-arrow-circle-right" style="color: blue; padding-left: 0.5em"></i></span>
                                <div class="transferToken_Wpayid_alias hidden">
                                    <div class="col-sm-9" style="padding: 0">
                                        @Html.TextBox("AliasToUser", "", new { @class = "form-control" })
                                    </div>
                                    <div class="col-sm-3" style="padding-left: 3px">
                                        <span class="btn btn-info hidden" id="btnSubmitTransferTokenLogic"><i class="fa  fa-arrow-circle-right" style="color: #ffffff;"></i></span>
                                        <span class="btn btn-default hidden" id="btnCancelTransferTokenLogic"><i class="fa fa-times-circle" style="color: red;"></i></span>
                                        <div class="fa fa-search icon-spin-search font-medium-2 hidden checkWPayIdAlias"></div>
                                    </div>
                                    @Html.ValidationMessage("AliasToUser", GlobalRes.DelegatedAuthority_MediaNameValidationError, new { @id = "TransferTokens_AliasToUser", @class = "hidden red" })
                                </div>

                            </div>
                        </div>
                    }
                </div>
                <br />
                <br />

                @*@{
                    Html.RenderPartial("DaLimitsPaymentTab/_DaLimiTabView", Model);
                }*@
                <div class="row" id="limitationBlock">
                </div>

                <div class="row" style="display: flex; justify-content: center" id="saveBlock">
                    <button type="submit" class="btn btn-success col-sm-2" id="saveDauth">@GlobalRes.User_ProfilePage_Save</button>
                    <a class="btn btn-danger col-sm-2 " id="deleteDauth" onclick="deactivateDevice('@Model.DaPayLimits_ID')">@GlobalRes.DelegatedAuthority_DeactivateDevice</a>
                </div>
            </div>
        }
    </section>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        $(".disable").find('input[data-input-amount]').prop("disabled", true).on("focus", function() {
            var focused = $(':focus');
            if (focused.val() && focused.val() == 0) {
                focused.text("");
                focused.val("");
            }
        }).on("blur", function() {
            if (this.value == '' || this.value == 0) {
                this.value = '0.00';
                this.text = "0.00";
            }
        });
        $(".disable").find('a[class="btn btn-success"]').attr("disabled", "disabled").on("click", function(event){
            if ($(this).is("[disabled]")) {
                event.preventDefault();
            }
        });

        @*SetSelectedCurrency("@Model.DaPayLimits_CcyCode");*@

    });

    $("#btnLoadTransferTokenLogic").click(function() {
        $("#transferTokenLabel").text("@GlobalRes.QrGenPage_SelectAlias");
        $("#btnCancelTransferTokenLogic").removeClass("hidden");
        $("#btnLoadTransferTokenLogic").addClass("hidden");
        $(".transferToken_Wpayid_alias").removeClass("hidden");
    });
    $("#btnCancelTransferTokenLogic").click(function() {
        $("#transferTokenLabel").text("");
        $("#btnCancelTransferTokenLogic").addClass("hidden");
        $("#btnLoadTransferTokenLogic").removeClass("hidden");
        $(".transferToken_Wpayid_alias").addClass("hidden");
    });
    $("#AliasToUser").on("keyup change", function () {
        $(".checkWPayIdAlias").removeClass("hidden");
        $("#btnSubmitTransferTokenLogic").addClass("hidden");

        setTimeout(function() {
            $.ajax({
                url: "@Url.Action("Post", "CheckAlias")",
                type: "POST",
                data: { 'aliasName': $("#AliasToUser").val()},
                dataType: "json",
                charset: 'utf-8'
            }).error(function (request, status, error) {
                console.log(request);
                console.log(status);
                console.log(error);

            }).success(function (data) {
                if (data.Success) {
                    $("#TransferTokens_AliasToUser").text();
                    $("#TransferTokens_AliasToUser").addClass("hidden");
                    $("#btnSubmitTransferTokenLogic").removeClass("hidden");
                } else {
                    $("#TransferTokens_AliasToUser").text(data.InfoBlock.UserMessage);
                    $("#TransferTokens_AliasToUser").removeClass("hidden");
                }
            });
            $(".checkWPayIdAlias").addClass("hidden");
        }, 200);

    });

    $("#text_DaPayLimits_LimitCodeInitialization").on("change", function () {
        if ($("#text_DaPayLimits_LimitCodeInitialization").val())
            $("#text_DaPayLimits_LimitCodeInitialization")
                .val($("#text_DaPayLimits_LimitCodeInitialization").val().toLower());
    });


    $('#btnSubmitTransferTokenLogic').click(function() {
        blockWindow();
        $.ajax({
            url: "@Url.Action("Post", "TransferTustedToken")",
            type: "POST",
            data: {
                'TokenId': $("#DaPayLimits_ID").val(),
                'AliasToUser': $("#AliasToUser").val()},
            dataType: "json",
            charset: 'utf-8'
        }).error(function (request, status, error) {
            console.log(request);
            console.log(status);
            console.log(error);
            $("#TransferTokens_AliasToUser").text(error);
            $("#TransferTokens_AliasToUser").removeClass("hidden");
            $.unblockUI();
        }).success(function (data) {
            if (data.Success) {
                $("#TransferTokens_AliasToUser").text();
                $("#TransferTokens_AliasToUser").addClass("hidden");
                $("#btnSubmitTransferTokenLogic").removeClass("hidden");
                location.href = '@Url.Action("Index", "DelegatedAuthority")';
            } else {
                $("#TransferTokens_AliasToUser").text("Token cann't be transfered");
                if (data.InfoBlock) {
                    $("#TransferTokens_AliasToUser").text(data.InfoBlock.UserMessage);
                }
                $("#TransferTokens_AliasToUser").removeClass("hidden");
                $.unblockUI();
            }
        });
    });

    $("#DaPayLimits_PinCode").keydown(function (e) {
        // Allow: backspace, delete, tab, escape, enter and .
        if ($.inArray(e.keyCode, [46, 8, 9, 27, 13, 110]) !== -1 ||
            // Allow: Ctrl+A, Command+A
            (e.keyCode === 65 && (e.ctrlKey === true || e.metaKey === true)) ||
            // Allow: home, end, left, right, down, up
            (e.keyCode >= 35 && e.keyCode <= 40)) {
            // let it happen, don't do anything
            return;
        }
        // Ensure that it is a number and stop the keypress
        if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
            if ($("#DaPayLimits_PinCode_validationMessage").hasClass('hidden'))
               $("#DaPayLimits_PinCode_validationMessage").removeClass('hidden');
            e.preventDefault();
        } else {
            if (!($("#DaPayLimits_PinCode_validationMessage").hasClass('hidden')))
                $("#DaPayLimits_PinCode_validationMessage").addClass('hidden');
        }
    }).blur(function()  {
        if (!($("#DaPayLimits_PinCode_validationMessage").hasClass('hidden'))) {
            setTimeout(function()  { $("#DaPayLimits_PinCode_validationMessage").addClass('hidden'); }, 2000);
        }
    }).focusout(function()  {
        if (!($("#DaPayLimits_PinCode_validationMessage").hasClass('hidden'))) {
            setTimeout(function()  { $("#DaPayLimits_PinCode_validationMessage").addClass('hidden'); }, 2000);
        }
    });

    function deactivateDevice(daId) {
        $.ajax({
            url: "@Url.Action("Delete", "DaPaymentLimitsList")",
            type: "POST",
            data: { 'daId': daId },
            dataType: "json",
            charset: 'utf-8',
            beforeSend: function () {
                $('#LoadingOverlayApi').trigger('loading-overlay:show');
            }
        }).error(function (request, status, error) {
            console.log(request);
            console.log(status);
            console.log(error);
        }).success(function(data) {
            console.log(data);
            if (!data.Success) {
                if (data.InfoBlock) {
                    $('#limitationBlock').append('<div class="alert alert-danger">' +
                        data.InfoBlock.UserMessage +
                        '</div>');
                } else {
                    $('#limitationBlock').append('<div class="alert alert-danger">' +
                        '@GlobalRes.ShopingCardController_UnspecError' +
                        '</div>');
                }
            }
            else {
                $('#limitationBlock').val(data.DaPayLimitsTab_ID);

                $('#limitationBlock').append('<div class="alert alert-success">' +
                    '' + data.InfoBlock.UserMessage+
                    '</div>');
            }
            setTimeout(function()  {
                $('#limitationBlock').empty();
                window.location.href = '@Url.Action("Index", "DelegatedAuthority")';
            }, 3000);

            $('#LoadingOverlayApi').trigger('loading-overlay:hide');
        });
    }


    $("#DaPayLimits_PinCode").on("change",
        function () {
            $('#DaPayLimits_PinCode_validationMessage').addClass('hidden');

            var pin = $("#DaPayLimits_PinCode").val();
            if (pin.length < 4) {
                $('#DaPayLimits_PinCode_validationMessage').text("@(GlobalRes.DelegatedAuthority_PinMore4Digits)");
                $('#DaPayLimits_PinCode_validationMessage').removeClass('hidden');
            }
        });
    $('#btnAddDateTime').click(function() {
        // set value to date and time
        $("#DaPayLimits_DateOfExpireString").val("@(DateTime.Now.ToString("dd/MM/yyyy"))");
        $("#DaPayLimits_TimeOfExpireString").val("@(DateTime.Now.ToString("HH:mm"))");
        $(this).parent().addClass("hidden");
        $("#blockDateExpire").removeClass("hidden");
        $("#blockTimeExpire").removeClass("hidden");
    });
    (function() {
        $.fn.serializeObject = function() {
            var o = {};
            var a = this.serializeArray();
            $.each(a,
                function() {
                    if (o[this.name]) {
                        if ((typeof (this.value) === "boolean") ||
                        (typeof (this.value) === "string" &&
                            this.value != undefined &&
                            (this.value.toLowerCase() === "true" || this.value.toLowerCase() === "false"))) {
                            o[this.name] =
                                ((o[this.name] == "true") | (this.value == "true"))
                                ? true
                                : false; //Sets value to true if one of two bits is true
                        } else {
                            if (!o[this.name].push) {
                                o[this.name] = [o[this.name]];
                            }
                            o[this.name].push(this.value || '');
                        }
                    } else {
                        o[this.name] = this.value || '';
                    }
                });
            return o;
        };
    })(jQuery);

     $('#DaPayLimits_CcyCode').change(function () {
        $('#DaPayLimits_CcyCode_validationMessage').addClass("hidden");
    });

    $('#selectButton').click(function () {
        setTimeout(function () { $('#searchabletext').focus(); }, 100);
    });
    $('#ddlmenu li a').on('click',
        function () {
            console.log("Func work");
            var id = $(this).data('pdsa-dropdown-val');
            var id1 = "";

            if (id != null) {
                console.log(id);
                var buttons = document.getElementById("selectButton");

                try {
                    id1 = id.toLowerCase();
                } catch (e) {
                    id1 = id;
                }

                buttons.innerHTML = '<img src="/Content/assets/images/onebyone.png" class="flag flag-' + id1 + '"/>' + '  ' +
                    id +
                    '&nbsp;<span class="caret" style="position: absolute; top: 45%; left: 97.5%; color: #555555 !important; border-top: 6px dashed !important; border-right: 3px solid transparent !important;border-left: 3px solid transparent !important"></span>';
                $("#ddlmenu").val(id);
                console.log("#ddlmenu");
                $("#DaPayLimits_CcyCode").val(id);
                $("#searchabletext").val("");
                $("#ddlmenu li").show();
                console.log("#DaPayLimits_CcyCode");
                $('#selectButton').removeClass("error_btn");
                $("#notificatorCcy").empty();
            }
            else {
                var buttons = document.getElementById("selectButton");
                buttons.innerHTML = '@String.Format(GlobalRes.Shared_NewInstantPaymentFormPage_SelectCurrency)' + '&nbsp;<span class="caret" style="position: absolute; top: 45%; left: 97.5%; color: #555555 !important; border-top: 6px dashed !important; border-right: 3px solid transparent !important;border-left: 3px solid transparent !important"></span>';
                $("#ddlmenu").val(null);
                //console.log("#ddlmenu");
                $("#DaPayLimits_CcyCode").val(null);
                $("#searchabletext").val("");
                $("#ddlmenu li").show();
                console.log("#DaPayLimits_CcyCode");
            }
        });

    $("#searchabletext").on("input", function () {
        var selText = $(this).val();
        //console.log($(this).val());
        $("#ddlmenu li").hide();
        $("#searchabli").show();
        $("#ddlmenu li").each(function () {
            if ($(this).text().trim().indexOf(selText.toUpperCase()) >= 0) {
                $("#curr_" + $(this).text().trim()).show();
            }
        });
        $("#searchabletext").one("keydown", function (e) {
            if (e.which == 13 || e.which == 10) {
                if ($("#ddlmenu li:visible").first() !== null) {
                    var el = $("#ddlmenu li:visible a").attr('display', 'list-item').first();
                    var id = el.data('pdsa-dropdown-val');
                    if (id != null) {
                        console.log("Entered");

                        console.log(id);
                        var buttons = document.getElementById("selectButton");
                        buttons.innerHTML = '<img src="/Content/assets/images/onebyone.png" class="flag flag-' + id.toLowerCase() + '"/>' + '  ' +
                            id +
                            '&nbsp;<span class="caret" style="position: absolute; top: 45%; left: 97.5%; color: #555555 !important; border-top: 6px dashed !important; border-right: 3px solid transparent !important;border-left: 3px solid transparent !important"></span>';
                        $("ddlmenu").val(id);
                        console.log("#ddlmenu");
                        $("#DaPayLimits_CcyCode").val(id);
                        $("#searchabletext").val("");
                        $("#ddlmenu li").show();
                        $('#selectButton').removeClass("error_btn");
                        $("#notificatorCcy").empty();
                    }

                    else { console.log("Not Entered"); }
                }
            }
        });

    });

    function SetRestrictionToSelectedCurrency(inpChBx) {        
        if ($(inpChBx).prop('checked')) {
            $(inpChBx).prop('checked', true);
            $("#DaPayLimits_IsRestrictedToSelectedCurrency").attr("value", "True");

        }
        else {
            $('#chkIsRestrictedToSelectedCurrency').prop('checked', false);
            $("#DaPayLimits_IsRestrictedToSelectedCurrency").attr("value", "False");

        }
    }

    function SetSelectedCurrency(ccy)
    {
        var ccy1 = "";
        var buttons = document.getElementById("selectButton");

        try {
            ccy1 = ccy.toLowerCase();
        } catch (e) {
            ccy1 = ccy;
        }

        buttons.innerHTML = '<img src="/Content/assets/images/onebyone.png" class="flag flag-' + ccy1 + '"/>' + '  ' +
            ccy +
            '&nbsp;<span class="caret" style="position: absolute; top: 45%; left: 97.5%; color: #555555 !important; border-top: 6px dashed !important; border-right: 3px solid transparent !important;border-left: 3px solid transparent !important"></span>';
        $("#ddlmenu").val(ccy);
    }

</script>

<link rel="stylesheet" href="/Content/assets/vendor/bootstrap-timepicker/css/bootstrap-timepicker.css">
<script src="/Content/assets/vendor/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>

<script src="/Content/assets/vendor/bootstrap-timepicker/bootstrap-timepicker.js"></script>