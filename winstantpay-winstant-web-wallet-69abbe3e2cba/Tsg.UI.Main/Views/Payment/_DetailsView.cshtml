@using Tsg.UI.Main.App_LocalResources
@using Tsg.UI.Main.Models.Security
@model Tsg.UI.Main.Models.InstantPaymentDetailsViewModel

<div class="row">
	<div class="col-md-12">
		<section class="panel">
			<header class="panel-heading" data-panel-toggle="">
				<div class="panel-actions">
					<a href="#" class="panel-action panel-action-toggle" data-panel-toggle=""></a>
				</div>

				<h2 class="panel-title">@ViewBag.Title</h2>
			</header>
			<div class="panel-body" style="display: block;">
				@if (Model.Errors.Count > 0)
				{
					foreach (var modelError in Model.Errors)
					{
						@Html.Display(modelError.Message)
					}
				}
				else
				{
					using (Html.BeginForm("Details", "Payment", new { id = Model.PaymentId }, FormMethod.Post, new { @id = "DetailsForm" }))
					{

						string[] crypto = { "BTC", "ETH", "XAU" };
						@*<div class="hidden">@Html.EditorForModel()</div>*@

						<input name="modid" id="modid" value="@Model.PaymentId" type="hidden" />
						<input name="res" id="res" value="file" type="hidden" />
						<table class="table table-striped table-bordered  mb-none" id="tbl_detail">
							<tbody>
								<tr>
									<td class="pt-md pb-md text-weight-bold">
										@GlobalRes.PaymentDetailsPage_PaymentReference
									</td>
									<td class="pt-md pb-md">
										@Html.DisplayFor(model => model.PaymentReference, new { @class = "form-control" })
									</td>
								</tr>
								<tr>

									<td class="pt-md pb-md text-weight-bold">
										@GlobalRes.PaymentDetailsPage_Status
									</td>
									<td class="pt-md pb-md">
										@Html.DisplayFor(model => model.PaymentStatus, new { @class = "form-control" }) &nbsp;&nbsp;
										@if (!(Model.PaymentStatus.Equals("Voided") || Model.PaymentStatus.Equals("Paid")) && Model.FromCustomerName == AppSecurity.CurrentUser.OrganisationName)
										{
											<a class="btn btn-success" href="@Url.Action("Post", "Payment", new {id = Model.PaymentId})">@GlobalRes.Shared_Navigation_PayNow</a>
										}
									</td>
								</tr>
								<tr>

									<td class="pt-md pb-md text-weight-bold">
										@GlobalRes.PaymentDetailsPage_From
									</td>
									<td class="pt-md pb-md">
										@Html.DisplayFor(model => model.FromCustomerAlias, new { @class = "form-control" })
									</td>
								</tr>
								<tr>
									<td class="pt-md pb-md text-weight-bold">
										@GlobalRes.PaymentDetailsPage_To
									</td>
									<td class="pt-md pb-md">
										@Html.DisplayFor(model => model.ToCustomerAlias, new { @class = "form-control" })
									</td>
								</tr>
								<tr>
									<td class="pt-md pb-md text-weight-bold">
										@GlobalRes.PaymentDetailsPage_Date
									</td>
									<td class="pt-md pb-md">
										@Html.DisplayFor(model => model.CreatedTime, new { @class = "form-control" })
									</td>
								</tr>
								<tr>
									<td class="pt-md pb-md text-weight-bold">
										@GlobalRes.PaymentDetailsPage_Currency
									</td>
									<td class="pt-md pb-md">
										@Html.DisplayFor(model => model.Currency, new { @class = "form-control" })
										<img src="/Content/assets/images/onebyone.png" class="flag flag-@(Model.Currency.ToLower())" />
									</td>
								</tr>
								<tr>
									<td class="pt-md pb-md text-weight-bold">
										@GlobalRes.PaymentDetailsPage_Amount
									</td>
									<td class="pt-md pb-md">
										@if (crypto.Contains(Model.Currency.ToUpper()))
										{
											<label> @(Model.Amount.ToString("N8"))</label>
										}
										else
										{
											<label> @(Model.Amount.ToString("N2"))</label>
										}
									</td>
								</tr>
								<tr>
									<td class="pt-md pb-md text-weight-bold">
										@GlobalRes.PaymentDetailsPage_Invoice
									</td>
									<td class="pt-md pb-md">
										@if (Model.ShopOrder != null)
										{
											<a aria-hidden="true" style="text-decoration: none; font-size: 18px" data-toggle="modal" data-target="#viewOrder" id="viewOrderBtn">
												@Html.DisplayFor(model => model.Invoice, new { @class = "form-control" })

											</a>
										}
										else
										{
											@Html.DisplayFor(model => model.Invoice, new { @class = "form-control" })
										}
									</td>
								</tr>

								<tr>
									<td class="pt-md pb-md text-weight-bold">
										@GlobalRes.Shared_NewInstantPaymentFormPage_ReasonForPayments
									</td>
									<td class="pt-md pb-md">
										@Html.DisplayFor(model => model.ReasonForPayment, new { @class = "form-control" })
									</td>
								</tr>
								<tr>
									<td class="pt-md pb-md text-weight-bold">
										@GlobalRes.PaymentDetailsPage_Memo
									</td>
									<td class="pt-md pb-md">
										@Html.DisplayFor(model => model.BankMemo, new { @class = "form-control" })
									</td>
								</tr>
							</tbody>
						</table>


						<footer class="panel-footer">
							<div class="row">
								<div class="col-sm-9">
									@if (Model.PaymentStatus.Equals("Paid"))
									{
										@*<div class="addthis_inline_share_toolbox"></div>*@
										<div class="col-sm-12 hidden" style="padding-left: 0 !important;" id="shareDiv">

											@Html.Partial("ShareButtons")

											@*<a id="submitlink" tabindex="1" class="at-share-btn btn btn-warning" style="border-radius: 12px; vertical-align: top" href="{url}">
													<span class="fa fa-download"></span>
												</a>*@

											@*<a id="submitlink" tabindex="1" class="btn btn-warning" style="border-radius: 12px; vertical-align: top">
													<span class="fa fa-download"></span>
												</a>*@
											<a id="submitlink" tabindex="1" class="btn btn-warning" style="border-radius: 12px; vertical-align: top">
												<span class="fa fa-download"></span>
											</a>

											@*<input type="submit" class="btn btn-warning" value="Download Payment Proof" id="btnFile" />*@

										</div>
										@*<input type="submit" class="btn btn-info" value="Prepare to Share" id="btnMessenger"/>*@
									}
								</div>
								<script type="text/javascript" language="javascript">
									$("#btnMessenger").on('click',
										function () {
											$("#res").val("messenger");
										});
									$("#btnFile").on('click',
										function () {
											$("#res").val("file");
										});
									$('a#submitlink').click(function () {
										//$.unblockUI();
										console.log(".DetailsForm submit enter");
										//$('form#DetailsForm').submit();
										//if (document.readyState == "loading") {
										//    $.unblockUI();
										//}
										//$.unblockUI();
										$('form#DetailsForm').submit();
										var url = '@String.Format(((System.Web.HttpRequestWrapper)Request).Url.Scheme + "://{0}", ((System.Web.HttpRequestWrapper) Request).Url.Authority)' + '@Url.Action("Details", "Payment", new { id=Model.PaymentId})';
										$.ajax(
										{
											url : url,
											contentType: 'application/json; charset=utf-8',
											datatype: 'json',
											type: "POST",
											success: function (data) {
												$.unblockUI();

											}
										});
									});
								</script>
							</div>
						</footer>
					}
				}


			</div>
		</section>
	</div>
</div>
<script>
	document.addEventListener("DOMContentLoaded",
		function() {
			$.ajax({
				url: "@Url.Action("GetImageLink", "Payment")",
				type: "POST",
				data: { id: "@Model.PaymentId", res: "" },
				dataType: "json",
				success: function(result) {
					console.log(result);
					var allbuttons = $('.at-share-btn[role="button"]');
					allbuttons.each(function() {
						var value = $(this).attr('href');
						console.log(value);
						if (value != null && value != 'undefined') {
							$(this).attr('href',
								value.replace('{url}',
									'@String.Format("http://{0}/SharedViewer/PaymentDetails?photoId=", ((System.Web.HttpRequestWrapper) Request).Url.Authority)' +
									result));

							$('#shareDiv').removeClass('hidden');
						}
					});
				}
			});
		});

	//$(document).ready(function () {



	//    $('a#submitlink').click(function () {

	//        $.blockUI();
	//        var id = $("#modid").val();
	//        $.ajax({
	//            type: "POST",
	//            url: '/Payment/Details/' + id + "?res=file",
	//            data: "",
	//            success: function (result) {
	//                // debugger
	//                var cookieval = "123";
	//                check(cookieval);
	//                window.location.href = '/Payment/Details/' + id  +'?ck=' + cookieval;

	//                $.unblockUI();
	//            }


	//        });

	//    });


	//    function check(cookieval) {

	//        var cookie = ReadCookie('ck');

	//        if (cookie != cookieval) {

	//            setTimeout(function () { check(cookieval) }, 1000);

	//            return true;

	//        }

	//        else {

	//            $.unblockUI();

	//            return true;

	//        }

	//    }



	//    function ReadCookie(cookieName) {

	//        var theCookie = "" + document.cookie;

	//        var ind = theCookie.indexOf(cookieName);

	//        if (ind == -1 || cookieName == "") return "";

	//        var ind1 = theCookie.indexOf(';', ind);

	//        if (ind1 == -1) ind1 = theCookie.length;

	//        return unescape(theCookie.substring(ind + cookieName.length + 1, ind1));

	//    }
	//});
	//document.addEventListener("onreadystatechange", function () {
	//    if (document.readyState == "loading") {
	//        $.unblockUI();
	//    }
	//});

	//function readyStateChanged() {
	//    alert(document.readyState);
	//    if (document.readyState == "loading") {
	//        $.unblockUI();
	//    }

	//}

	//$(document).on('readystatechange', readyStateChanged);
</script>
