@using System.Globalization
@using Tsg.UI.Main.App_LocalResources
@using Tsg.UI.Main.Models
@using TSG.Models.Enums
@using WinstantPay.Common.Extension
@model TSG.Models.ServiceModels.AddFundsWire

@{
    ViewBag.Title = GlobalRes.Shared_Navigation_AddFunds;
    Layout = "~/Views/Shared/_LayoutMain.cshtml";
}
<link href="/Content/viewer/viewer.css" rel="stylesheet">
<script src="/Content/viewer/viewer.js"></script>
@using (Html.BeginForm("UpdateWireInstruction", "Funding", FormMethod.Post, new { enctype = "multipart/form-data" }))
{
    @Html.AntiForgeryToken()
    string[] crypto = { "BTC", "ETH", "XAU" };

    <div class="form-horizontal">
        <section class="panel  @(ViewBag.OpenPanel != null ? "" : "panel-featured panel-featured-info")">

            <header class="panel-heading">
                <h2 class="panel-title">@GlobalRes.ProofDocUploadProofDocPage_Title</h2>
                <p class="panel-subtitle">@GlobalRes.ProofDocUploadProofDocPage_SubTitle</p>
            </header>
            <div class="panel-body">
                @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                @Html.HiddenFor(h => h.AddFundsWire_ParentId)
                @Html.HiddenFor(h => h.AddFundsWire_ProofDocId)


                @if (Model.AddFundsWire_Fundings == null || Model.AddFundsWire_Fundings.Fundings_StatusByFund == (int)FundingStatus.Pending)
                {
                    if (Model.AddFundsWire_Fundings != null)
                    {
                        <div class="form-group">
                            <label class="col-sm-3 control-label">@GlobalRes.ProofDocUploadProofDocPage_Status </label>
                            <div class="col-sm-6">
                                @{
                                    var description = EnumHelper<FundingStatus>.GetDisplayValue((FundingStatus)Model.AddFundsWire_Fundings.Fundings_StatusByFund);
                                }
                                @Html.TextBox("status", description, new { @class = "form-control", required = "", disabled = "disabled" })
                            </div>
                        </div>
                    }
                    <div class="form-group">
                        <label class="col-sm-3 control-label">@GlobalRes.ProofDocUploadProofDocPage_ReceivingBank <span class="required" aria-required="true">*</span></label>
                        <div class="col-sm-6">
                            @Html.DropDownListFor(m => m.AddFundsWire_BankCcyId, UiHelper.PrepareAvailableBankCurrencies(), new { @class = "form-control", required = "" })
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-3 control-label">@GlobalRes.ProofDocUploadProofDocPage_Amount <span class="required" aria-required="true">*</span></label>
                        <div class="col-sm-6">
                            <input class="form-control" id="AddFundsWire_Amount" name="AddFundsWire_Amount" required="" type="number" min="0" step="0.01" value="@(Model.AddFundsWire_Fundings != null && Model.AddFundsWire_Fundings.Fundings_Amount != 0 ? Model.AddFundsWire_Fundings.Fundings_Amount.ToString("G29") : "")" ,
                                   onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46 || event.charCode === 38 || event.charCode === 40 || event.charCode === 0" ,
                                   @(Model.AddFundsWire_Fundings != null && Model.AddFundsWire_Fundings.Fundings_StatusByFund > (int)FundingStatus.Pending ? "disabled=\"disabled\"" : "") />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">@GlobalRes.ProofDocUploadProofDocPage_PaymentDate <span class="required" aria-required="true">*</span></label>
                        <div class="col-sm-6">
                            <div class="input-group date" data-plugin-datepicker="" data-date-format="dd/mm/yyyy" id="dp3">
                                <span class="input-group-addon">
                                    <i class="fa fa-calendar"></i>
                                </span>
                                @Html.TextBoxFor(t => t.AddFundsWire_PaymentDateString, Model.AddFundsWire_PaymentDate.ToString("dd/MM/yyyy", CultureInfo.CreateSpecificCulture("en-US")), new { @class = "form-control", onchange = "changeDateInPicker();", @readonly = "readonly" })
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-3 control-label">@GlobalRes.ProofDocUploadProofDocPage_NameOfSender <span class="required" aria-required="true">*</span></label>
                        <div class="col-sm-6">

                            @Html.TextBoxFor(m => m.AddFundsWire_CustName, new
                            {
                                @Value = !String.IsNullOrEmpty(Model.AddFundsWire_CustName) ? Model.AddFundsWire_CustName : (Tsg.UI.Main.Models.Security.AppSecurity.CurrentUser.FirstName + " " + Tsg.UI.Main.Models.Security.AppSecurity.CurrentUser.LastName),
                                @class = "form-control",
                                required = ""
                            })

                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-3 control-label">@GlobalRes.ProofDocUploadProofDocPage_NameOfSendingBank <span class="required" aria-required="true">*</span></label>
                        <div class="col-sm-6">
                            @Html.TextBoxFor(m => m.AddFundsWire_BankName, new { @class = "form-control", required = "" })
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-3 control-label">@GlobalRes.ProofDocUploadProofDocPage_AccountNumber <span class="required" aria-required="true">*</span></label>
                        <div class="col-sm-6">
                            @Html.TextBoxFor(m => m.AddFundsWire_LastFourDigits, new { @class = "form-control", required = "" })
                        </div>
                    </div>


                    <div class="form-group">
                        <label class="col-sm-3 control-label">@GlobalRes.ProofDocUploadProofDocPage_OtherInformation </label>
                        <div class="col-sm-6">
                            @Html.TextBoxFor(m => m.AddFundsWire_Other, new { @class = "form-control" })
                        </div>
                    </div>
                    if (File.Exists(Server.MapPath("~/Uploads/" + Model.AddFundsWire_FileName)))
                    {
                        @Html.HiddenFor(h => h.AddFundsWire_FileName)
                        @Html.HiddenFor(h => h.AddFundsWire_FilePath)
                        <div class="form-group">
                            <label class="col-sm-3 control-label">@GlobalRes.ProofDocUploadProofDocPage_AttachmentFile</label>
                            <div class="col-sm-8">
                                <div>
                                    <img id="image" src="~/Uploads/@Model.AddFundsWire_FileName" class="img-rounded" style="max-width: 200px; max-height: 200px; " />
                                </div>
                                <script>
                                    var viewer = new Viewer(document.getElementById('image'), { toolbar: 0, navbar: 0, rotatable: 0, fullscreen: 0, title: 0 });
                                </script>
                            </div>
                        </div>
                    }
                    if (Model.AddFundsWire_Fundings == null || Model.AddFundsWire_Fundings.Fundings_StatusByFund == (int)FundingStatus.Pending)
                    {
                        <div class="form-group">
                            <label class="col-sm-3 control-label">@GlobalRes.ProofDocUploadProofDocPage_AttachProof</label>
                            <div class="col-sm-8" id="file_load">
                                <div class="btn btn-primary" onclick="document.getElementById('AddFundsWire_PostedFile').click()">@GlobalRes.ProofDocUploadProofDocPage_AttachmentFile</div>
                                <label> @GlobalRes.CommonObject_NoFile </label>
                                <input type="file" name="AddFundsWire_PostedFile" id="AddFundsWire_PostedFile" accept="image/*" class="hidden" />
                            </div>
                        </div>
                    }

                }
                else if (Model.AddFundsWire_Fundings != null && Model.AddFundsWire_Fundings.Fundings_StatusByFund > (int)FundingStatus.Pending)
                {
                    <div class="row">
                        <div class="col-md-12">
                            <table class="table table-striped table-bordered  mb-none" id="tbl_detail">
                                <tbody>
                                    <tr>
                                        <td class="pt-md pb-md text-weight-bold">
                                            @GlobalRes.ProofDocUploadProofDocPage_Status
                                        </td>
                                        <td class="pt-md pb-md">
                                            @{
                                                var description = EnumHelper<FundingStatus>.GetDisplayValue((FundingStatus)Model.AddFundsWire_Fundings.Fundings_StatusByFund);
                                            }
                                            @if (Model.AddFundsWire_Fundings.Fundings_StatusByFund == (int)FundingStatus.InProcess)
                                            {
                                                <span class="label btn-xs btn-default_custom">@description</span>
                                            }
                                            @if (Model.AddFundsWire_Fundings.Fundings_StatusByFund == (int)FundingStatus.Pending)
                                            {
                                                <span class="label btn-xs btn-warning_custom">@description</span>
                                            }
                                            @if (Model.AddFundsWire_Fundings.Fundings_StatusByFund == (int)FundingStatus.Credited)
                                            {
                                                <span class="label btn-xs btn-success_custom">@description</span>
                                            }
                                            @if (Model.AddFundsWire_Fundings.Fundings_StatusByFund == (int)FundingStatus.Canceled)
                                            {
                                                <span class="label btn-xs btn-danger_custom">@description</span>
                                            }
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="pt-md pb-md text-weight-bold">
                                            @GlobalRes.ProofDocUploadProofDocPage_ReceivingBank
                                        </td>
                                        <td class="pt-md pb-md">
                                            @{
                                                var bname = UiHelper.PrepareAvailableBankCurrencies().FirstOrDefault(f => f.Value == Model.AddFundsWire_BankCcyId.ToString());
                                            }
                                            @if (bname != null)
                                            {
                                                @bname.Text
                                            }
                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="pt-md pb-md text-weight-bold">
                                            @GlobalRes.PaymentDetailsPage_Amount
                                        </td>
                                        <td class="pt-md pb-md">
                                            @if (Model.AddFundsWire_Fundings != null && crypto.Contains(Model.AddFundsWire_Fundings.Fundings_Currency.Currency_CcyCode.ToUpper()))
                                            {
                                                <label>
                                                    @(Model.AddFundsWire_Fundings.Fundings_Amount.ToString("N8"))

                                                </label>
                                            }
                                            else
                                            {
                                                <label>
                                                    @(Model.AddFundsWire_Fundings.Fundings_Amount.ToString("N2"))
                                                </label>
                                            }
                                            @Model.AddFundsWire_Fundings.Fundings_Currency.Currency_CcyCode
                                            <img src="/Content/assets/images/onebyone.png" class="flag flag-@(Model.AddFundsWire_Fundings.Fundings_Currency.Currency_CcyCode.ToLower())" />

                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="pt-md pb-md text-weight-bold">
                                            @GlobalRes.ProofDocUploadProofDocPage_PaymentDate
                                        </td>
                                        <td class="pt-md pb-md">
                                            @Model.AddFundsWire_PaymentDate.ToString("dd/MM/yyyy", CultureInfo.CreateSpecificCulture("en-US"))
                                        </td>
                                    </tr>


                                    <tr>

                                        <td class="pt-md pb-md text-weight-bold">
                                            @GlobalRes.ProofDocUploadProofDocPage_NameOfSender
                                        </td>
                                        <td class="pt-md pb-md">
                                            @Html.DisplayFor(model => model.AddFundsWire_CustName, new { @class = "form-control" })
                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="pt-md pb-md text-weight-bold">
                                            @GlobalRes.ProofDocUploadProofDocPage_NameOfSendingBank
                                        </td>
                                        <td class="pt-md pb-md">
                                            @Html.DisplayFor(model => model.AddFundsWire_BankName, new { @class = "form-control" })
                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="pt-md pb-md text-weight-bold">
                                            @GlobalRes.ProofDocUploadProofDocPage_AccountNumber
                                        </td>
                                        <td class="pt-md pb-md">
                                            @Html.DisplayFor(model => model.AddFundsWire_LastFourDigits, new { @class = "form-control" })
                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="pt-md pb-md text-weight-bold">
                                            @GlobalRes.ProofDocUploadProofDocPage_OtherInformation
                                        </td>
                                        <td class="pt-md pb-md">
                                            @Html.DisplayFor(model => model.AddFundsWire_Other, new { @class = "form-control" })
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="pt-md pb-md text-weight-bold">
                                            @GlobalRes.ProofDocUploadProofDocPage_AttachmentFile
                                        </td>
                                        <td class="pt-md pb-md">
                                            @if (File.Exists(Server.MapPath("~/Uploads/" + Model.AddFundsWire_FileName)))
                                            {
                                                @Html.HiddenFor(h => h.AddFundsWire_FileName)
                                                @Html.HiddenFor(h => h.AddFundsWire_FilePath)
                                                <img id="image" src="~/Uploads/@Model.AddFundsWire_FileName" class="img-rounded" style="max-width: 200px; max-height: 200px; " />
                                                <script>
                                                    var viewer = new Viewer(document.getElementById('image'), { toolbar: 0, navbar: 0, rotatable: 0, fullscreen: 0, title: 0 });
                                                </script>
                                            }
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                }

                <div class="form-group">
                    <div class="col-md-offset-3 col-md-10" style="color:green">
                        @ViewBag.Message
                    </div>
                </div>


            </div>


            <footer class="panel-footer">
                <div class="row">
                    <div class="col-sm-9 col-sm-offset-3">
                        @if (Model.AddFundsWire_Fundings == null || Model.AddFundsWire_Fundings.Fundings_StatusByFund == (int)FundingStatus.Pending)
                        {
                            <input type="submit" class="btn btn-success" value="@GlobalRes.ProofDocUploadProofDocPage_Save" />
                        }
                        <a class="btn btn-success" href="@Url.Action("GetAllFundings")">@GlobalRes.ProofDocUploadProofDocPage_DepositHistory</a>
                    </div>
                </div>
            </footer>

        </section>
    </div>
}

@section Scripts {
    @*@Scripts.Render("~/bundles/jqueryval")*@


    @if (Model.AddFundsWire_PaymentDate == default(DateTime))
    {
        <script type="text/javascript">
            $(document).ready(function () {

                $.fn.datepicker.defaults.format = "dd/mm/yyyy";
                $("#dp3").datepicker("setDate", new Date());

            });
        </script>
    }
    else
    {
        <script type="text/javascript">
            $(document).ready(function () {

                $.fn.datepicker.defaults.format = "dd/mm/yyyy";
                $("#dp3").datepicker("setDate", new Date('@Model.AddFundsWire_PaymentDate.ToString("MM/dd/yyyy")'));

            });
        </script>
    }

    <script type="text/javascript">
        $("#AddFundsWire_PostedFile").on("change",
            function () {
                var fileApi = (window.File && window.FileReader && window.FileList && window.Blob) ? true : false;

                var wrapper = $("#file_load"),
                    inp = wrapper.find("input"),
                    btn = wrapper.find("button"),
                    lbl = wrapper.find("label");

                var fileName;
                if (fileApi && inp[0].files[0])
                    fileName = inp[0].files[0].name;
                else
                    fileName = inp.val().replace("C:\\fakepath\\", '');

                if (!fileName.length)
                    return;
                if (lbl.is(":visible")) {
                    lbl.text(fileName);
                }
            }).change();
        
        function changeDateInPicker() {
            $.fn.datepicker.defaults.format = "dd/mm/yyyy";

            //$("#datedaily").val($("#dp3").data('datepicker').getFormattedDate('dd/mm/yyyy'));
            $("#PaymentDate").val($("#dp3").data('datepicker').getFormattedDate('dd/mm/yyyy'));
            //console.log($("#datedaily").val());
            console.log($("#PaymentDate").val());
        }

        $("#AddFundsWire_BankCcyId").on("change",
            function () {
                var currencyName = $('#AddFundsWire_BankCcyId :selected').text();
                console.log(currencyName);
                if (currencyName.includes("BTC") || currencyName.includes("ETH")) {
                    $('#AddFundsWire_Amount').attr('step', 0.00001);
                } else {
                    $('#AddFundsWire_Amount').attr('step', 0.01);
                    var v = Math.round($('#AddFundsWire_Amount').val() * 100) / 100;
                    $('#AddFundsWire_Amount').val(v);
                }
            }).change();
    </script>
}