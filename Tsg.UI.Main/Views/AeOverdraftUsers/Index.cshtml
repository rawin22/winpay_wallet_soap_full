@using System.Net.Http
@using Tsg.UI.Main.App_LocalResources
@model IEnumerable<TSG.Models.ServiceModels.AutomaticExchange.LiquidOverDraftUserListSo>

    @{
        ViewBag.Title = "Overdraft customer";
        Layout = "~/Views/Shared/_LayoutMain.cshtml";
    }
    <!-- Specific Page Vendor CSS -->
    <link rel="stylesheet" href="/Content/assets/vendor/select2/css/select2.css" />
    <link rel="stylesheet" href="/Content/assets/vendor/select2-bootstrap-theme/select2-bootstrap.css" />
    <link rel="stylesheet" href="/Content/assets/vendor/jquery-datatables-bs3/assets/css/datatables.css" />


    <script src="/Content/assets/vendor/select2/js/select2.js"></script>
    <script src="/Content/assets/vendor/jquery-datatables/media/js/jquery.dataTables.js"></script>
    <script src="/Content/assets/vendor/jquery-datatables/extras/TableTools/js/dataTables.tableTools.min.js"></script>
    <script src="/Content/assets/vendor/jquery-datatables-bs3/assets/js/datatables.js"></script>

    <link href="~/Content/assets/vendor/bootstrap-toggle/css/bootstrap-toggle.css" rel="stylesheet">
    <script src="~/Content/assets/vendor/bootstrap-toggle/js/bootstrap-toggle.js"></script>
    <script src="/Scripts/jquery.unobtrusive-ajax.min.js" type="text/javascript"></script>
    <style>
        .toggle-on {
            color: #ffffff !important;
        }
    </style>

    <script src="~/Content/inputmask/jquery.inputmask.bundle.js"></script>

    <section class="panel panel-featured panel-featured-info">
        <header class="panel-heading" data-panel-toggle="">
            <div class="panel-actions">
                <a href="#" class="panel-action panel-action-toggle" data-panel-toggle=""></a>
            </div>

            <h2 class="panel-title">@ViewBag.Title</h2>
            <p class="panel-subtitle">Overdraft user list</p>
        </header>
        
        
        

        <div class="panel-body">
            <div class="row" style="padding-bottom: 10px">
                <div class = "col-sm-12" >
                    <a class = "btn btn-info" id = "addOverdraftUser" data-toggle = "modal" data-target = "#addOverdraftUserModalWindow" >Add</a>
                </div>
            </div>
            <div class="modal fade" id="addOverdraftUserModalWindow" tabindex="-1" role="dialog" aria-labelledby="addOverdraftUserModalWindow-label" aria-hidden="true">
                <div class="modal-dialog" role="document">
                   
                    @{
                        AjaxOptions options = new AjaxOptions();
                        options.HttpMethod = "POST";
                        options.OnSuccess = "success_query_AddOverdraftUser";
                        options.OnBegin = "begin_query_AddOverdraftUser";
                        options.OnFailure = "failure_query_AddOverdraftUser";
                    }
                    @using (Ajax.BeginForm("SaveOverdraftUser", "AeOverdraftUsers", options, new {id= "form_AddOverdraftUser" }))
                    {
                        <div class="modal-content">
                            <div class="modal-header">
                                <img src="/Content/assets/images/winstantpay-logo-notag.png" height="35" alt="" />
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="margin-top: 5px">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="form-group">
                                    <label>User</label>
                                    @Html.DropDownList("userId", ViewBag.Users as IEnumerable<SelectListItem>, new { @class = "form-control", id = "userId" })
                                    @Html.ValidationMessage("userId", new{})
                                </div>
                                @*<div class="form-group">
                                    <label>Currency</label>
                                    @Html.DropDownList("currencyId", ViewBag.Currency as IEnumerable<SelectListItem>, new { @class = "form-control", id = "currencyId" })
                                    @Html.ValidationMessage("currencyId", new { })
                                </div>
                                <div class="form-group">
                                    <label>Amount</label>
                                    @Html.TextBox("overdraftAmount", 0, new { @class = "form-control", @id = "overdraftAmount" })
                                    @Html.ValidationMessage("overdraftAmount", new { })
                                </div>*@
                            </div>
                            <div class="modal-footer">
                                @Html.ValidationMessage("totalValidation", new {@id = "totalValidation", @class = "alert alert-danger hidden" })
                                <input type="submit" class="btn btn-success" title="@GlobalRes.EditBankPage_Save"/>
                            </div>
                        </div>
                    }
                </div>
            </div>


            <table class="table table-bordered table-striped table-condensed mb-none" id="datatable_overdraft_user"></table>

            <script type="text/javascript" language="javascript">
                $("#overdraftAmount").inputmask("decimal");
                var tableData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model));

                var table = $("#datatable_overdraft_user").dataTable({
                    responsive: true,
                    "searching": false,
                    "deferRender": true,
                    "destroy": true,
                    //data: tableData,
                    "ajax": {
                        "url": '@Url.Action("GetOverdraftUser", "AeOverdraftUsers")',
                        "type": "POST",
                        "beforeSend": function() {

                        },
                        "dataSrc": function(json) {
                            console.log(json);
                            return json;
                        }
                    },
                    columns: [
                        { title: "Customer", data: "LiquidOverDraftUserList_FullName" },
                        { title: "Account Rep", data: "LiquidOverDraftUserList_AccountRep" },
                        //{
                        //    title: "Limit",
                        //    "mRender": function(data, type, full) {
                        //        return '<b>' +
                        //            full.LiquidOverDraftUserList_Amount +
                        //            '</b> ' +
                        //            '<img src="/Content/assets/images/onebyone.png" class="flag flag-' +
                        //            full.LiquidOverDraftUserList_LiquidCcyList.LiquidCcyList_CurrencyCode
                        //            .toLowerCase() +
                        //            '"/> <span>' +
                        //            full.LiquidOverDraftUserList_LiquidCcyList.LiquidCcyList_CurrencyCode +
                        //            '</span>';
                        //    }
                        //},
                        {
                            title: "Date",
                            data: "LiquidOverDraftUserList_CreationDate",
                            "type": "date",
                            "format": "dd.MM.yyyy HH:mm:ss",
                            "mRender": function(data, type, full) {
                                return moment(parseInt(data.replace("/Date(", "").replace(")/", ""), 10))
                                    .format('DD.MM.YYYY HH:mm');
                            }
                        },
                        {
                            title: "Action",
                            "mRender": function(data, type, full) {
                                return '<button class="btn btn-danger" onclick=deleteOverdraft("' +
                                    full.LiquidOverDraftUserList_Id.toString() +
                                    '")>Delete</button>';
                            }
                        }
                    ],
                });

                function begin_query_AddOverdraftUser() {
                    $.blockUI({
                        message:
                            '<div class="loader-wrapper"><div class="loader-container"><div class="line-scale"><div></div><div></div><div></div><div></div><div></div></div></div></div>',
                        overlayCSS: {
                            backgroundColor: '#FFF',
                            opacity: 0.8,
                            cursor: 'wait'
                        },
                        css: {
                            border: 0,
                            padding: 0,
                            backgroundColor: 'transparent'
                        }
                    });
                }

                function success_query_AddOverdraftUser(data) {
                    console.log(data);
                    if (!data.Success) {
                        $('#totalValidation').removeClass("hidden");
                        $('#totalValidation').text(data.InfoBlock.UserMessage);
                    } else {
                        table.api().ajax.reload();
                        $('#addOverdraftUserModalWindow').modal('toggle');
                        $("#userId option[value='"+data.Obj+"']").remove();
                    }
                    $.unblockUI();
                }

                function failure_query_AddOverdraftUser(data) {

                    $('#totalValidation').removeClass("hidden");
                    $('#totalValidation').text("Invalid data");
                    $.unblockUI();

                }

                function deleteOverdraft(id) {
                    Swal({
                        title: 'Are you sure?',
                        text: "You won't be able to revert this!",
                        type: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Yes, delete it!'
                    }).then((result) => {
                        if (result.value) {
                            const swalWithBootstrapButtons = swal.mixin({
                                confirmButtonClass: 'btn btn-success',
                                cancelButtonClass: 'btn btn-danger',
                                buttonsStyling: false,
                            });
                            $.ajax({
                                url: '@Url.Action("Delete", "AeOverdraftUsers")',
                                type: "POST",
                                data: { 'id': id },
                                success: function(data) {
                                    if (data.Success) {
                                        swalWithBootstrapButtons(
                                            'Deleted!',
                                            'Your item has been deleted.',
                                            'success');
                                    } else {
                                        swalWithBootstrapButtons(
                                            'Cancelled',
                                            data.Message,
                                            'error');
                                    }
                                    location.reload();
                                    blockWindow();
                                }
                            });
                        }
                    });
                }
            </script>
        </div>
    </section>
