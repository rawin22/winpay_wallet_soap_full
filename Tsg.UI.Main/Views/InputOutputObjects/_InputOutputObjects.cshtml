@using System.Net.Http
@using Tsg.UI.Main.App_LocalResources


<!-- Specific Page Vendor CSS -->
<link rel="stylesheet" href="/Content/assets/vendor/select2/css/select2.css" />
<link rel="stylesheet" href="/Content/assets/vendor/select2-bootstrap-theme/select2-bootstrap.css" />
<link rel="stylesheet" href="/Content/assets/vendor/jquery-datatables-bs3/assets/css/datatables.css" />


<script src="/Content/assets/vendor/jquery-datatables/media/js/jquery.dataTables.js"></script>
<script src="/Content/assets/vendor/jquery-datatables/extras/TableTools/js/dataTables.tableTools.min.js"></script>
<script src="/Content/assets/vendor/jquery-datatables-bs3/assets/js/datatables.js"></script>

<link href="~/Content/assets/vendor/bootstrap-toggle/css/bootstrap-toggle.css" rel="stylesheet">
<script src="~/Content/assets/vendor/bootstrap-toggle/js/bootstrap-toggle.js"></script>
<script src="/Scripts/jquery.unobtrusive-ajax.min.js" type="text/javascript"></script>

<script src="~/Content/inputmask/jquery.inputmask.bundle.js"></script>

<section class="panel panel-featured panel-featured-info panel-collapsed" id="incomingEnvelopesPanel">
    <header class="panel-heading" data-panel-toggle="">
        <div class="panel-actions">
            <a href="#" class="panel-action panel-action-toggle" data-panel-toggle=""></a>
        </div>

        <h2 class="panel-title">@GlobalRes.MainPage_Inbox</h2>
        <p class="panel-subtitle"></p>
    </header>

    <div class="panel-body">
        <table class="table table-bordered table-striped table-condensed mb-none table-w-100" id="datatable_historicalData_user">
            <thead>
                <tr>
                    <th> #</th>
                    <th> @GlobalRes.Inbox_Index_Table_Header_Topic</th>
                    <th> @GlobalRes.Inbox_Index_Table_Header_Date</th>
                    <th> @GlobalRes.Inbox_Index_Table_Header_Type</th>
                    <th> @GlobalRes.Inbox_Index_Table_Header_From</th>
                    <th> @GlobalRes.Inbox_Index_Table_Header_Info</th>
                    <th> @GlobalRes.Inbox_Index_Table_Header_Status</th>
                    <th> @GlobalRes.FundingGetFundRequestsPage_Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <script type="text/javascript" language="javascript">

            var tableInput = $("#datatable_historicalData_user").dataTable({
                responsive: true,
                "searching": false,
                "deferRender": true,
                "destroy": true,
                "ajax": {
                    "url": '@Url.Action("JsonInputHistoricalData", "InputOutputObjects")',
                    "type": "POST",
                    "beforeSend": function() {

                    },
                    "dataSrc": function(json) {
                        return json;
                    }
                },
                columns: [
                    {
                        title: "#",
                        data: null,
                        className: "tab-1",
                        "render": function(data, type, full, meta) {
                            return meta.row + 1;
                        },
                        "max-width": "20px",
                        "width": "20px"
                    },
                    { title: "@GlobalRes.Inbox_Index_Table_Header_Topic", data: "GetInboxList_Source" },
                    {
                        title: "@GlobalRes.Inbox_Index_Table_Header_Date",
                        "type": "date",
                        "format": "dd.MM.yyyy HH:mm:ss",
                        "mData": function(source, type, val) {
                            return moment(new Date(source.GetInboxList_CreatedDate.match(/\d+/)[0] * 1));
                        },
                        "mRender": function(data, type, full) {
                            if (full.GetInboxList_CreatedDate && full.GetInboxList_CreatedDate.trim()) {

                                var calldate =
                                ((full.GetInboxList_CreatedDate)
                                    ? moment(new Date(full.GetInboxList_CreatedDate.match(/\d+/)[0] * 1))
                                    .format('DD.MM.YYYY HH:mm:ss')
                                    : '');

                                return calldate; //+ '  |  ' + typeCall;
                            }
                        }
                    },
                    {
                        title: "@GlobalRes.Inbox_Index_Table_Header_Type",
                        data: "GetInboxList_TypeRecBySourceEnumString"
                    },
                    { title: "@GlobalRes.Inbox_Index_Table_Header_From", data: "GetInboxList_TransferParent" },
                    {
                        title: "@GlobalRes.Inbox_Index_Table_Header_Info",
                        "mRender": function(data, type, full, meta) {
                            var renderedpart = '';
                            if (full.GetInboxList_SourceType === 1) {
                                if (full.GetInboxList_TypeRecBySource === 1) {
                                    renderedpart = '<span><i class="fa fa-qrcode"></i></span>';
                                } else if (full.GetInboxList_TypeRecBySource === 2) {
                                    renderedpart = '<span><i class="fa fa-barcode"></i></span>';
                                } else if (full.GetInboxList_TypeRecBySource === 3) {
                                    renderedpart = '<span><i class="fa fa-rss-square"></i></span>';
                                } else if (full.GetInboxList_TypeRecBySource === 4) {
                                    renderedpart = '<span><i class="fa fa-wallet"></i></span>';
                                }
                                renderedpart += ' ' + full.GetInboxList_MediaNameByTransferToken;
                            } else if (full.GetInboxList_SourceType === 2) {
                                renderedpart = full.GetInboxList_Info;
                            }

                            return renderedpart;
                        },
                    },
                    {
                        title: "@GlobalRes.Inbox_Index_Table_Header_Status",
                        data: "GetInboxList_StatusEnumString"
                    },
                    {
                        title: "@GlobalRes.FundingGetFundRequestsPage_Action",
                        "mRender": function(data, type, full, meta) {
                            if (!full.GetInboxList_AcceptedDate) {
                                if (full.GetInboxList_SourceType === 1) {
                                    let renderTrToken =
                                        '<a class="btn btn-success" id="accept_token" onclick="acceptDeclineTokenEvent(\'' +
                                            full.GetInboxList_Id +
                                            '\', true)">@GlobalRes.CommonWords_Accept</a>' +
                                            '<a class="btn btn-danger" id="decline_token" onclick="acceptDeclineTokenEvent(\'' +
                                            full.GetInboxList_Id +
                                            '\', false)">@GlobalRes.CommonWords_Decline</a>';
                                    return renderTrToken;

                                } else if (full.GetInboxList_SourceType === 2) {
                                    let renderRedEnvelope =
                                        '<a class="btn btn-info" id="detail_envelope" onclick="getDetatilsRedEnvelopeEvent(\'' +
                                            full.GetInboxList_Id +
                                            '\', true)">Details</a>'+
                                        '<a class="btn btn-success" id="accept_token" onclick="acceptDeclineRedEnvelopeEvent(\'' +
                                            full.GetInboxList_Id +
                                            '\', true)">@GlobalRes.CommonWords_Accept</a>' +
                                            '<a class="btn btn-danger" id="decline_token" onclick="showDeclinedModalBox(\'' +
                                            full.GetInboxList_Id +
                                            '\', false)">@GlobalRes.CommonWords_Decline</a>';
                                    return renderRedEnvelope;
                                }
                            } else if (full.GetInboxList_SourceType === 2 && full.GetInboxList_AcceptedDate) {
                                let renderRedEnvelope =
                                    '<a class="btn btn-info" id="detail_envelope" onclick="getDetatilsRedEnvelopeEvent(\'' +
                                        full.GetInboxList_Id +
                                        '\', true)">Details</a>';
                                return renderRedEnvelope;
                            }
                            else return '';

                        }
                    }
                ]
            });

        </script>

        <div class="modal fade" id="redEnveloreDeclineModal" tabindex="-1" role="dialog" aria-labelledby="redEnveloreDeclineModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <img src="/Content/assets/images/winstantpay-logo-notag.png" height="35" alt="" />
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="margin-top: 5px">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">Rejection Note<span class="required" aria-required="true">*</span></label>
                            <div class="col-sm-12">
                                @Html.TextArea("redEnveloreDeclineText", new { @class = "form-control" })
                            </div>
                        </div>
                        @Html.Hidden("recordId")
                        @Html.Hidden("actionStatus")
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-info col-sm-12" onclick="clickDeclineBtn()">
                            <span aria-hidden="true" class="fa fa-close" style="margin-right: 10px"></span>Decline red envelope
                        </button>
                    </div>
                </div>
            </div>
        </div>



        <div class="modal fade" id="redEnveloreDetailsModal" tabindex="-1" role="dialog" aria-labelledby="redEnveloreDetailsModalLabel" aria-hidden="true">
            <link href="/Content/viewer/viewer.css" rel="stylesheet">
            <script src="/Content/viewer/viewer.js"></script>
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <img src="/Content/assets/images/winstantpay-logo-notag.png" height="35" alt="" />
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="margin-top: 5px">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body" id="bodyDetailsEnvelope">

                    </div>
                </div>
            </div>

        </div>
    </div>
</section>


<script type="text/javascript" language="javascript">
    function getDetatilsRedEnvelopeEvent(rowId) {
        $.ajax({
            url: "@Url.Action("Details", "ReceipRedEnvelope")",
            type: "POST",
            data: {
                'rowId': rowId
            },
            dataType: "html",
            //contentType: "",
            charset: 'utf-8'
        }).error(function(request, status, error) {
            console.log(request);
            console.log(status);
            console.log(error);
            swal({
                title: error,
                timer: 3000,
                type: 'warning',
                showConfirmButton: false
            });
            }).success(function (data) {
                $("#bodyDetailsEnvelope").html(data);
                setTimeout(function () {
                    $('#redEnveloreDetailsModal').modal("toggle");

                }, 200);
        });
    }

    function acceptDeclineTokenEvent(transferId, isAccepted) {
        var transferedTokenId = transferId;
        blockWindow();
        $.ajax({
            url: "@Url.Action("Post", "ReceipTustedToken")",
            type: "POST",
            data: {
                'TransferedRecordId': transferId,
                'Action': isAccepted
            },
            dataType: "json",
            charset: 'utf-8'
        }).error(function (request, status, error) {
            console.log(request);
            console.log(status);
            console.log(error);
            $.unblockUI();
            swal({
                title: error,
                timer: 3000,
                type: 'warning',
                showConfirmButton: false
            });}).success(function (data) {
            $.unblockUI();
            if (data.Success) {
                swal({
                    title: data.InfoBlock.UserMessage,
                    timer: 3000,
                    type: 'success',
                    showConfirmButton: true
                });
                location.reload();
            } else {
                swal({
                    title: data.InfoBlock.UserMessage,
                    timer: 5000,
                    type: 'warning',
                    showConfirmButton: true
                });

            }
        });
    }

    function showDeclinedModalBox(transferId, isAccepted) {
        $('#recordId').val(transferId);
        $('#actionStatus').val(isAccepted);
        $('#redEnveloreDeclineModal').modal("toggle");
    }

    function clickDeclineBtn() {
        $('#redEnveloreDeclineModal').modal('toggle');
        acceptDeclineRedEnvelopeEvent($('#recordId').val(), $('#actionStatus').val(), $('#redEnveloreDeclineText').val());
        $('#redEnveloreDeclineText').val("");
    }

    function acceptDeclineRedEnvelopeEvent(transferId, isAccepted, rejectednote) {
        var transferedTokenId = transferId;
        blockWindow();
        $.ajax({
            url: "@Url.Action("Post", "ReceipRedEnvelope")",
            type: "POST",
            data: {
                'TransferedRecordId': transferId,
                'Action': isAccepted,
                'RejectionNote': rejectednote
            },
            dataType: "json",
            charset: 'utf-8'
        }).error(function (request, status, error) {
            console.log(request);
            console.log(status);
            console.log(error);
            $.unblockUI();
            swal({
                title: error,
                timer: 3000,
                type: 'warning',
                showConfirmButton: false
            });}).success(function (data) {
            $.unblockUI();
            if (data.Success) {
                swal({
                    title: data.InfoBlock.UserMessage,
                    timer: 3000,
                    type: 'success',
                    showConfirmButton: true
                });
                location.reload();
            } else {
                swal({
                    title: data.InfoBlock.UserMessage,
                    timer: 5000,
                    type: 'warning',
                    showConfirmButton: true
                });
            }
        });
    }
</script>


<section class="panel panel-featured panel-featured-info panel-collapsed">
    <header class="panel-heading" data-panel-toggle="">
        <div class="panel-actions">
            <a href="#" class="panel-action panel-action-toggle" data-panel-toggle=""></a>
        </div>

        <h2 class="panel-title">@GlobalRes.MainPage_Outbox</h2>
        <p class="panel-subtitle"></p>
    </header>

    <div class="panel-body">
        <table class="table table-bordered table-striped table-condensed mb-none table-w-100" id="datatable_historicalOutputData_user">
            <thead>
                <tr>
                    <th> #</th>
                    <th> @GlobalRes.Inbox_Index_Table_Header_Topic</th>
                    <th> @GlobalRes.Inbox_Index_Table_Header_Date</th>
                    <th> @GlobalRes.Inbox_Index_Table_Header_Type</th>
                    <th> @GlobalRes.Inbox_Index_Table_Header_To</th>
                    <th> @GlobalRes.Inbox_Index_Table_Header_Info</th>
                    <th> @GlobalRes.Inbox_Index_Table_Header_Status</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <script type="text/javascript" language="javascript">

            var tableOutput = $("#datatable_historicalOutputData_user").dataTable({
                responsive: true,
                "searching": false,
                "deferRender": true,
                "destroy": true,
                "ajax": {
                    "url": '@Url.Action("JsonOutputHistoricalData", "InputOutputObjects")',
                    "type": "POST",
                    "beforeSend": function() {

                    },
                    "dataSrc": function(json) {
                        console.log(json);
                        return json;
                    }
                },
                columns: [
                    {
                        title: "#",
                        data: null,
                        className: "tab-1",
                        "render": function(data, type, full, meta) {
                            return meta.row + 1;
                        },
                        "max-width": "20px",
                        "width": "20px"
                    },
                    { title: "@GlobalRes.Inbox_Index_Table_Header_Topic", data: "GetInboxList_Source" },
                    {
                        title: "@GlobalRes.Inbox_Index_Table_Header_Date",
                        "type": "date",
                        "format": "dd.MM.yyyy HH:mm:ss",
                        "mData": function(source, type, val) {
                            return moment(new Date(source.GetInboxList_CreatedDate.match(/\d+/)[0] * 1));
                        },
                        "mRender": function(data, type, full) {
                            if (full.GetInboxList_CreatedDate && full.GetInboxList_CreatedDate.trim()) {

                                var calldate =
                                ((full.GetInboxList_CreatedDate)
                                    ? moment(new Date(full.GetInboxList_CreatedDate.match(/\d+/)[0] * 1))
                                    .format('DD.MM.YYYY HH:mm:ss')
                                    : '');

                                return calldate; //+ '  |  ' + typeCall;
                            }
                        }
                    },
                    {
                        title: "@GlobalRes.Inbox_Index_Table_Header_Type",
                        data: "GetInboxList_TypeRecBySourceEnumString"
                    },
                    { title: "@GlobalRes.Inbox_Index_Table_Header_To", data: "GetInboxList_TransferRecipient" },
                    {
                        title: "@GlobalRes.Inbox_Index_Table_Header_Info",
                        "mRender": function(data, type, full, meta) {
                            var renderedpart = '';
                            if (full.GetInboxList_SourceType === 1) {
                                if (full.GetInboxList_TypeRecBySource === 1) {
                                    renderedpart = '<span><i class="fa fa-qrcode"></i></span>';
                                } else if (full.GetInboxList_TypeRecBySource === 2) {
                                    renderedpart = '<span><i class="fa fa-barcode"></i></span>';
                                } else if (full.GetInboxList_TypeRecBySource === 3) {
                                    renderedpart = '<span><i class="fa fa-rss-square"></i></span>';
                                } else if (full.GetInboxList_TypeRecBySource === 4) {
                                    renderedpart = '<span><i class="fa fa-wallet"></i></span>';
                                }
                                renderedpart += ' ' + full.GetInboxList_MediaNameByTransferToken;
                            } else if (full.GetInboxList_SourceType === 2) {
                                renderedpart = full.GetInboxList_Info;
                            }

                            return renderedpart;
                        },
                    },
                    {
                        title: "@GlobalRes.Inbox_Index_Table_Header_Status",
                        data: "GetInboxList_StatusEnumString"
                    }
                ]
            });

        </script>
    </div>
</section>